<!DOCTYPE html>
<html>
  <head>
    <title>Momo Tetrix</title>
        <script type="module">
            import {TetrixPiece, TetrixGround} from './js/tetrix_model.js';
            import {rgb, TetrixBox, TetrixStackArea} from './js/tetrix_drawing.js';

            const BLOCK_WIDTH = 25;
            const BOK_WIDTH = 100;
            const GROUND_BLOCKS_X = 10;
            const GROUND_BLOCKS_Y = 20;
            const INIT_GAME_SPEED = 1000;
            
            function process_images() {
                let logoIcon = new Image();
                logoIcon.src = 'images/logo.jpg';
                document.body.appendChild(logoIcon);

                let images = Array.from(document.getElementsByTagName('img'));
                images.forEach(image => {
                    document.body.removeChild(image);
                });

                return images;
            }

            window.onload = function() {        
                let images = process_images();
                
                // Prepare TetrixBox
                let tetrixboxCanvas = document.getElementById('tetrixbox');
                tetrixboxCanvas.width = BOK_WIDTH;
                tetrixboxCanvas.height = BOK_WIDTH;
                let tetrixBox = new TetrixBox(images, tetrixboxCanvas);
                let piece = TetrixPiece.randomFreezePiece();
                tetrixBox.paint(piece);    
        
                // Prepare TetrixGround
                let tetrixGround = new TetrixGround(10, 20);
                tetrixGround.addPieceOfType(piece.type);
                
                // Prepare TetrixStackArea
                let stackareaCanvas = document.getElementById('stackarea');
                stackareaCanvas.width = GROUND_BLOCKS_X * BLOCK_WIDTH;
                stackareaCanvas.height = GROUND_BLOCKS_Y * BLOCK_WIDTH;        
                let stackArea = new TetrixStackArea(images, stackareaCanvas);
                stackArea.paint(tetrixGround);
                
                // GAME
                let levelLabel = document.getElementById('level');
                let lineLabel = document.getElementById('line');
                let scoreLabel = document.getElementById('score');

                let isRestart = true;
                let isPause = false;
                let level = 1;
                let speed = INIT_GAME_SPEED;
                                
                document.getElementById('newGame').onclick = function() {
                    this.blur();
                    isRestart = true;
                    // wait for 1 seconds to end the previous game
                    setTimeout(function() {
                        function down() {
                            if(!isPause) {
                                tetrixGround.moveTetrixDown();
                                tetrixGround.updateGround();
                               
                                if(!tetrixGround.isMovable(0, 1)) { 
                                    tetrixGround.addPieceOfType(piece.type);
                                    piece = TetrixPiece.randomFreezePiece();
                                    tetrixBox.paint(piece);
                                    lineLabel.innerHTML = tetrixGround.removedLines;
                                    scoreLabel.innerHTML = tetrixGround.score;
                                }
                                
                                stackArea.paint(tetrixGround);
                                
                                if((tetrixGround.score / 50) > (level - 1)) {
                                    level++;
                                    if(speed > 200) {
                                        speed -= 100;
                                    }
                                    levelLabel.innerHTML = level;
                                }
                            
                                if(!tetrixGround.isGameover && !isRestart) {
                                    setTimeout(down, speed);
                                }
                            }
                        }
                        
                        level = 1;
                        speed = INIT_GAME_SPEED;
                        tetrixGround.reset();
                        levelLabel.innerHTML = level;
                        lineLabel.innerHTML = tetrixGround.removedLines;
                        scoreLabel.innerHTML = tetrixGround.score;
                        
                        isRestart = false;                        
                        down();
                    }, 1000);
                };
                
                document.getElementById('pause').onclick = function() {
                    this.blur();
                    isPause = true;
                    alert('           Paused - https://openhome.cc');
                    isPause = false;
                };
                
                document.onkeydown = function(event) {
                    if(isRestart || tetrixGround.isGameover || isPause) {
                        return;
                    }
                    
                    switch (event.which) {
                        case 39: // Right
                            tetrixGround.moveTetrixRight()
                            break;
                        case 37: // Left
                            tetrixGround.moveTetrixLeft();
                            break;
                       case 38: // Up
                            tetrixGround.rotateTetrix(false);
                            break;
                       case 40: // Down
                            tetrixGround.rotateTetrix(true);
                            break;
                       case 32: // Space
                            tetrixGround.dropTetrix();
                            break;
                    }
                    stackArea.paint(tetrixGround);
                };
            };
        </script>
    <meta charset="UTF-8">
  </head>
  <body>
    <div style="text-align: right;"><a href="https://github.com/JustinSDK/MomoTetrixHTML5-Toy">GitHub</a></div>
    Momo Tetrix - Use Up, Down, Left, Right and Space to play. <br>
    <br>
    <canvas id="stackarea" style="border-style: solid; border-width: 1px; float: left;"></canvas> <canvas

      id="tetrixbox" style="border-style: solid; border-width: 1px; margin-left: 10px; padding-top: 5px; padding-left: 5px;"></canvas><br>
    <br>
    　　Level : <span id="level">0</span><br>
    　　Lines : <span id="line">0</span><br>
    　　Score : <span id="score">0</span><br>
    <br>
    　<button id="newGame">New Game</button><br>
    　<button id="pause">Pause</button><br>
    <br>
    <img src="images/1.jpg"> <img src="images/2.jpg"> <img src="images/3.jpg"> <img

      src="images/4.jpg"> <img src="images/5.jpg"> <img src="images/6.jpg"> <img

      src="images/7.jpg">
  </body>
</html>
